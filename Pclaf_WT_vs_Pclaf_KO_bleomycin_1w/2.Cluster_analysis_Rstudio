##Marker Supplementary table 3, Extended Data Fig. 5b
lung.markers <- FindAllMarkers(Epi, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)

saveRDS(lung.markers, file = "/Users/bkim6/Desktop/LAB/Seq/R/PafWT_PafKO_lung_bleo1w/analysis/lung.markers.rds")

library(openxlsx)
write.xlsx(lung.markers, file = "lung_markers_myscRNAseq_20220522.xlsx")

lung.markers %>%
  group_by(cluster) %>%
  top_n(n = 10, wt = avg_log2FC) -> top10


DoHeatmap(
  Epi,
  features = top10$gene,
  size = 8,
  group.by = "cell_type",
  group.bar = TRUE,
  group.colors = NULL,
  draw.lines = TRUE) + scale_fill_gradientn(colors = c("blue", "white", "red"))
  
##DimPlots, Extended Data Fig. 6a, Fig. 2a, and Fig. 2b

Idents(Epi) <- "PafID"

DimPlot(Epi)

Idents(Epi) <- "cell_type"

DimPlot(Epi)

DimPlot(Epi, split.by = "PafID")

##cell proportion test, Fig. 2c
library(scProportionTest)
prop_test <- sc_utils(Epi)

prop_test <- permutation_test(
  prop_test, cluster_identity = "cell_type",
  sample_1 = "PafWT", sample_2 = "PafKO",
  sample_identity = "PafID")
permutation_plot(prop_test)

##Marker genes, Extended Data Fig. 6b, and 6c

gene_list_marker <- c("Pclaf", "Mki67", "Ager","Cldn18", "Sftpc", "Sftpa1", "Krt8", "Scgb1a1", "Scgb3a2", "Foxj1", "Ccdc153", "Scgb3a1", "Reg3g", "Chga", "Calca", "Krt5", "Trp63", "Cd200", "Itgb4")

DotPlot(Epi, features = gene_list_marker, cols = "RdYlBu") +coord_flip() + theme(axis.text.x = element_text(angle = 45, hjust = 1) )

FeaturePlot(object = Epi,
            features = c("Pclaf", "Mki67", "Ager", "Sftpc", "Krt8", "Scgb1a1", "Foxj1", "Scgb3a1", "Krt5"),
            cols = c("lightgray", "Red"), pt.size = 0.2)

##Specify of AT2 cells, Extended Data Fig. 6d, and 6e

DotPlot(Epi, feature = c("Sftpc", "Sftpa1", "Tmsb4x", "Lyz2", "Cxcl15", "Lcn2", "Slc34a2", "Hc", "Sftpb", "Lamp3"), cols = "RdYlBu") +coord_flip() + theme(axis.text.x = element_text(angle = 45, hjust = 1) )

FeaturePlot(object = Epi,
            features = c("Lcn2", "Slc34a2"),
            cols = c("lightgray", "Red"), pt.size = 0.2)

##DREAM target gene module score, Fig. 3d
Epi <- AddModuleScore(object = Epi, features = gene_list_DREAM, name = "DREAM_score")
DotPlot(Epi, feature = "DREAM_score1", split.by = "PafID", cols = "RdYlBu")

##Wnt target gene, Extended Data Fig. 8a
DotPlot(Epi, features = c("Axin2", "Myc", "Ascl2"), cols = "RdYlBu", split.by = "PafID")

DotPlot(Epi, features = c("Cd44", "Ccnd1", "Jag1", "Bmp4", "Met"), cols = "RdYlBu", split.by = "PafID")

##Sox9-based progenitor gene signature, Extended Data Fig. 8b
Epi <- AddModuleScore(object = Epi, features = progenitor_signature, name = "progenitor_score")

DotPlot(Epi, features = "progenitor_score1", cols = "RdYlBu", split.by = "PafID")

##Myc-target gene, Extended Data Fig. 8c
Epi <- AddModuleScore(object = Epi, features = gene_list_Myc, name = "Myc_score")

DotPlot(Epi, feature = c("Myc", "Max", "Myc_score1"), split.by = "PafID", cols = "RdYlBu", scale.min = 0)

##GSEA analysis, Fig. 3c, Extended Data Fig. 7b, Fig. 4e

library(presto)
library(fgsea)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(msigdbr)
library(openxlsx)

#PPC subset
Epi_PPC <- subset(Epi, idents = "PPC")
Idents(Epi_PPC) <- "PafID"

#msigdbr database
msigdbr_species()

m_df<- msigdbr(species = "Mus musculus", category = "C2")

head(m_df)

fgsea_sets<- m_df %>% split(x = m_df$gene_symbol, f = m_df$gs_name)

#wilcoxauc
Epi_PPC.genes <- wilcoxauc(Epi_PPC, 'PafID')

head(Epi_PPC.genes)


Epi_PPC.genes <- Epi_PPC.genes %>%
  filter(!logFC %in% c('0'))

dplyr::count(Epi_PPC.genes, group)

##12176 genes


Epi_PPC.genes %>%
  dplyr::filter(group == "PafWT") %>%
  arrange(desc(logFC), desc(auc)) %>%
  head(n = 10)

Epi_PPC.genes <- Epi_PPC.genes %>% 
  dplyr::filter(group == "PafWT") %>%
  arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)

write.xlsx(Epi_PPC.genes, file = "Epi_PPC.genes.xlsx")


ranks_PPC <- deframe(Epi_PPC.genes)
head(ranks_PPC)

#Positive pathway(C2)

fgseaRes_PPC <- fgsea(fgsea_sets, stats = ranks_PPC, nperm = 10000)

fgseaResTidy_PPC <- fgseaRes_PPC %>%
  as_tibble() %>%
  arrange(desc(NES))

fgseaResTidy_PPC %>% 
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>% 
  arrange(desc(NES)) %>% 
  DT::datatable()

ggplot(fgseaResTidy_PPC %>% head(n= 20), aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill= padj<0.01)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title="C2 pathways NES from GSEA_Pos") + 
  theme_minimal()

#negative pathway (C2)
fgseaResTidy_PPC <- fgseaRes_PPC %>%
  as_tibble() %>%
  arrange(NES)

fgseaResTidy_PPC %>% 
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>% 
  arrange(NES) %>% 
  DT::datatable()

ggplot(fgseaResTidy_PPC %>% head(n= 20), aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill= padj<0.01)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title="C2 pathways NES from GSEA_Neg") + 
  theme_minimal()
  
  #GSEA plot
  plotEnrichment(fgsea_sets[["FISCHER_DREAM_TARGETS"]],
               ranks_PPC) + labs(title="FISCHER_DREAM_TARGETS_PPC")
  plotEnrichment(fgsea_sets[["KOINUMA_TARGETS_OF_SMAD2_OR_SMAD3"]],
               ranks_PPC) + labs(title="KOINUMA_TARGETS_OF_SMAD2_OR_SMAD3")

##Smad3 target genes, Fig. 4d

Epi <- AddModuleScore(object = Epi, features = gene_list_tgf_target_a549, name = "tgf_a549_score")
Epi <- AddModuleScore(object = Epi, features = gene_list_tgf_mES, name = "tgf_mES_score")
Epi <- AddModuleScore(object = Epi, features = gene_list_tgf_hES, name = "tgf_hES_score")
DotPlot(Epi, features = c("tgf_a549_score1", "tgf_mES_score1", "tgf_hES_score1"), cols = "RdYlBu", split.by = "PafID", scale.min = 0) 
